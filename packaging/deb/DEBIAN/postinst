#!/bin/bash
set -e

INSTALL_DIR="/usr/share/jarvis"
VENV_DIR="$INSTALL_DIR/venv"

echo "Configurando JARVIS..."

# Crear entorno virtual si no existe
if [ ! -d "$VENV_DIR" ]; then
    echo "Creando entorno virtual..."
    python3 -m venv "$VENV_DIR"
fi

# Instalar dependencias Python
echo "Instalando dependencias Python..."
"$VENV_DIR/bin/pip" install --quiet --upgrade pip
"$VENV_DIR/bin/pip" install --quiet vosk sounddevice PyYAML pyaudio numpy PyQt5

# Descargar modelo Vosk si no existe
MODEL_DIR="$INSTALL_DIR/models"
MODEL_NAME="vosk-model-small-es-0.42"

if [ ! -d "$MODEL_DIR/$MODEL_NAME" ]; then
    echo "Descargando modelo de voz (esto puede tardar)..."
    mkdir -p "$MODEL_DIR"
    cd "$MODEL_DIR"
    wget -q "https://alphacephei.com/vosk/models/$MODEL_NAME.zip" -O model.zip
    unzip -q model.zip
    rm model.zip
fi

# Actualizar cache de iconos
if command -v gtk-update-icon-cache &> /dev/null; then
    gtk-update-icon-cache -f /usr/share/icons/hicolor/ 2>/dev/null || true
fi

# Actualizar base de datos de desktop
if command -v update-desktop-database &> /dev/null; then
    update-desktop-database /usr/share/applications/ 2>/dev/null || true
fi

echo "JARVIS instalado correctamente."
echo "Ejecuta 'jarvis-gui' o busca JARVIS en el menu de aplicaciones."
